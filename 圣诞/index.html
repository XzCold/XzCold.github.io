<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magical Christmas Tree</title>
    <style>
        :root {
            --glass-bg: rgba(20, 20, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glow-color-start: rgba(255, 200, 0, 0.5);
            --glow-color-end: rgba(255, 240, 150, 0.8);
            --img-radius: 20px;
            /* å®šä¹‰æ§åˆ¶æ é«˜åº¦ï¼ŒJSåŠ¨æ€è®¡ç®—å¯èƒ½æ›´å¥½ï¼Œè¿™é‡Œç»™ä¸€ä¸ªå®‰å…¨é¢„ä¼°å€¼ */
            --controls-height: 160px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at 50% 30%, #2c3e50 0%, #0f2027 100%);
            /* æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ dvh (Dynamic Viewport Height) è§£å†³æ‰‹æœºæµè§ˆå™¨åœ°å€æ é®æŒ¡é—®é¢˜ */
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            touch-action: none;
        }

        /* === å¯åŠ¨é¡µ === */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); transition: opacity 0.5s;
        }
        #start-btn {
            padding: 18px 45px; font-size: 18px; font-weight: bold;
            background: linear-gradient(45deg, #ff4757, #ff6b81); color: white;
            border: none; border-radius: 50px; box-shadow: 0 0 30px rgba(255, 71, 87, 0.6);
            cursor: pointer; animation: pulseBtn 1.5s ease-in-out infinite;
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* === åœºæ™¯å®¹å™¨ === */
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        
        .main-container {
            position: relative; width: 100%; 
            /* ä½¿ç”¨ 100dvh å¡«æ»¡å¯è§†åŒºåŸŸ */
            height: 100dvh;
            display: flex; flex-direction: column; align-items: center; 
            /* é¡¶éƒ¨ç•™ç™½ï¼Œé˜²æ­¢é¡¶åˆ°åˆ˜æµ· */
            padding-top: max(10px, env(safe-area-inset-top)); 
            perspective: 1000px;
            /* ç‚¹å‡»èƒŒæ™¯é€€å‡ºä¸“æ³¨æ¨¡å¼çš„åŒºåŸŸ */
            cursor: default;
        }

        /* === æ ‘çš„å®¹å™¨ (æ ¸å¿ƒåŠ¨æ•ˆå±‚) === */
        .tree-wrapper {
            position: relative; z-index: 5; cursor: crosshair;
            width: auto; max-width: 90vw;
            
            /* æ ¸å¿ƒé€‚é…ï¼šåœ¨æ™®é€šæ¨¡å¼ä¸‹ï¼Œé«˜åº¦è¦ç¼©å‡ï¼Œç»™åº•éƒ¨UIç•™å‡ºç»å¯¹è¶³å¤Ÿçš„ç©ºé—´ */
            /* è¿™é‡Œçš„ calc ç¨å¾®æ¿€è¿›ä¸€ç‚¹ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
            height: auto; 
            max-height: calc(100dvh - var(--controls-height) - 40px);
            
            display: flex; justify-content: center; align-items: center;
            border-radius: var(--img-radius);
            box-shadow: 0 0 20px var(--glow-color-start), 0 0 40px rgba(255, 215, 0, 0.1);
            
            /* ä¸æ»‘è¿‡æ¸¡é…ç½®ï¼šè´å¡å°”æ›²çº¿ */
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        max-height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                        box-shadow 0.5s ease;
            
            animation: breatheGlow 4s ease-in-out infinite alternate;
            transform-origin: center center; /* ä»ä¸­å¿ƒæ”¾å¤§ */
        }

        /* å‘¼å¸å…‰æ•ˆ */
        @keyframes breatheGlow {
            0% { box-shadow: 0 0 15px var(--glow-color-start); }
            100% { box-shadow: 0 0 30px var(--glow-color-end), 0 0 60px rgba(255, 236, 139, 0.2); }
        }

        /* === çŠ¶æ€ï¼šä¸“æ³¨æ¨¡å¼ (æ”¾å¤§) === */
        .tree-wrapper.is-focused {
            /* æ”¾å¤§æ¯”ä¾‹ */
            transform: scale(1.1);
            /* æ”¾å¤§æ—¶å¢åŠ é˜´å½±ç«‹ä½“æ„Ÿ */
            box-shadow: 0 20px 60px var(--glow-color-end), 0 0 100px rgba(255, 215, 0, 0.3);
            animation: none; /* æ”¾å¤§æ—¶åœæ­¢å‘¼å¸ï¼Œä¿æŒé«˜äº® */
            z-index: 50; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

        #tree-img {
            display: block; width: auto; height: auto; max-width: 100%; max-height: 100%;
            object-fit: contain; border-radius: var(--img-radius); vertical-align: middle; 
            transition: filter 0.3s;
        }
        .tree-wrapper.is-focused #tree-img {
            /* æ”¾å¤§æ—¶ç¨å¾®æäº® */
            filter: brightness(1.05) contrast(1.05);
        }

        /* === æ­Œè¯ & æç¤º === */
        .lyrics-box {
            position: absolute; 
            /* ä½ç½®æŒ‚åœ¨æ§åˆ¶æ ä¸Šæ–¹ */
            bottom: calc(var(--controls-height) + 10px); 
            width: 100%; text-align: center; pointer-events: none; z-index: 20;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .lyric-line {
            display: inline-block; padding: 6px 16px; background: rgba(0,0,0,0.5); border-radius: 20px;
            color: #f1c40f; font-size: 15px; font-weight: bold; opacity: 0; transform: translateY(10px); transition: all 0.4s ease;
        }
        .lyric-line.show { opacity: 1; transform: translateY(0); }

        /* === åº•éƒ¨æ§åˆ¶æ  (UIä¼˜åŒ–ç‰ˆ) === */
        .glass-controls {
            position: absolute; 
            /* é€‚é… iPhone åº•éƒ¨æ¨ªæ¡ safe-area */
            bottom: max(15px, env(safe-area-inset-bottom)); 
            left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 440px; 
            padding: 12px 16px;
            
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 22px;
            
            display: flex; flex-direction: column; gap: 10px; 
            z-index: 100; box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ä¸“æ³¨æ¨¡å¼ä¸‹ï¼ŒUI éšè— */
        .main-container.focus-mode .glass-controls {
            opacity: 0;
            transform: translateX(-50%) translateY(50px) scale(0.9); /* ä¸‹æ²‰å¹¶ç¼©å°æ¶ˆå¤± */
            pointer-events: none;
        }
        
        /* ä¸“æ³¨æ¨¡å¼ä¸‹ï¼Œæ­Œè¯ä¹Ÿéšè— */
        .main-container.focus-mode .lyrics-box {
            opacity: 0;
        }

        .top-hint { color: rgba(255,255,255,0.6); font-size: 11px; text-align: center; letter-spacing: 0.5px; }
        .row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        
        .btn {
            flex: 1; padding: 10px 0; border: none; border-radius: 10px;
            font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.95);
            background: rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.92); background: rgba(255,255,255,0.25); }
        .btn.primary { background: linear-gradient(90deg, #ff4757, #ff6b81); box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        .btn.active { background: #fff; color: #333; box-shadow: 0 0 12px rgba(255,255,255,0.4); }
        
        #music-toggle { 
            width: 38px; height: 38px; flex: none; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 16px; background: #f1c40f; color: #333; box-shadow: 0 0 8px #f1c40f;
        }
        #music-toggle.playing { animation: spin 4s linear infinite; box-shadow: 0 0 15px #f1c40f; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* === ç¯å…‰ä¸ç²’å­ === */
        .light {
            position: absolute; width: 14px; height: 14px; border-radius: 50%; transform: translate(-50%, -50%) scale(0);
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), currentColor 60%);
            box-shadow: 0 0 8px currentColor, 0 0 16px currentColor; 
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, breathe 2s infinite alternate ease-in-out 0.4s; pointer-events: none; z-index: 10;
        }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }
        @keyframes breathe { 0% { opacity: 0.8; filter: brightness(1); } 100% { opacity: 1; filter: brightness(1.3); } }
        .spark {
            position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; pointer-events: none; z-index: 15; animation: explode 0.6s ease-out forwards;
        }
        @keyframes explode { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } }
        .star-halo {
            position: absolute; top: 6%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(255,215,0,0.5) 0%, transparent 70%);
            animation: rotateHalo 12s linear infinite; pointer-events: none; z-index: 4; mix-blend-mode: screen;
        }
        @keyframes rotateHalo { from{transform:translate(-50%, -50%) rotate(0deg);} to{transform:translate(-50%, -50%) rotate(360deg);} }

        /* å°å±é¢å¤–ä¼˜åŒ– */
        @media (max-height: 600px) { 
            :root { --controls-height: 130px; } 
            .glass-controls { padding: 8px 12px; gap: 6px; } 
            .tree-wrapper { transform: scale(0.9); } /* å°å±é»˜è®¤å†å°ä¸€ç‚¹ */
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <div style="font-size: 60px; margin-bottom: 20px; filter: drop-shadow(0 0 20px gold);">ğŸ„</div>
        <button id="start-btn">å¼€å¯åœ£è¯é­”æ³•</button>
        <div style="color: #ccc; margin-top: 15px; font-size: 13px; text-align:center; line-height:1.6;">
            ğŸ’¡ è‹¹æœæ‰‹æœºè¯·å…³é—­ä¾§è¾¹ã€é™éŸ³æ¨¡å¼ã€‘<br>ç‚¹å‡»å›¾ç‰‡æ”¾å¤§ï¼Œç‚¹å‡»èƒŒæ™¯æ¢å¤
        </div>
    </div>

    <audio id="bgm" loop preload="auto" playsinline webkit-playsinline><source src="music.mp3" type="audio/mpeg"></audio>
    <canvas id="snow-canvas"></canvas>

    <div class="main-container">
        <div class="tree-wrapper" id="click-area">
            <div class="star-halo"></div>
            <img src="å¾®ä¿¡å›¾ç‰‡_20251225225217_76_79.jpg" id="tree-img" alt="åœ£è¯æ ‘" onerror="alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶åã€‚')">
        </div>
        <div class="lyrics-box"><div id="lyric-text" class="lyric-line">Magic is loading...</div></div>
    </div>

    <div class="glass-controls" id="ui-panel">
        <div class="top-hint">ç‚¹å‡»æ ‘èº«æŒ‚ç¯ Â· åˆ‡æ¢ä¸»é¢˜æ”¹æ°›å›´ âœ¨</div>
        <div class="row">
            <button id="music-toggle" onclick="toggleMusic()">ğŸµ</button>
            <button class="btn primary" onclick="autoDecorate()">ğŸ ä¸€é”®è£…é¥°</button>
            <button class="btn" style="background:rgba(255,255,255,0.2)" onclick="clearScene()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <div class="row">
            <button class="btn active theme-btn" onclick="switchTheme('multi', this)">ğŸŒˆ å½©è™¹</button>
            <button class="btn theme-btn" onclick="switchTheme('gold', this)">âœ¨ æš–é‡‘</button>
            <button class="btn theme-btn" onclick="switchTheme('ice', this)">â„ï¸ å†°é›ª</button>
        </div>
    </div>

    <script>
        // === 1. å¯åŠ¨ä¸éŸ³é¢‘ ===
        const audio = document.getElementById('bgm');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const musicBtn = document.getElementById('music-toggle');
        
        startBtn.addEventListener('click', function() {
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.visibility = 'hidden', 600);
            audio.currentTime = 0; audio.volume = 0.8; audio.muted = false;
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    musicBtn.classList.add('playing'); showLyric("Merry Christmas! ğŸ¶");
                    setTimeout(() => autoDecorate(15), 500);
                }).catch(error => { console.error("Audio error:", error); showLyric("è¯·æ£€æŸ¥é™éŸ³é”®å¹¶ç‚¹å‡»å·¦ä¸‹è§’æ’­æ”¾"); });
            }
        });
        
        function toggleMusic() {
            if (audio.paused) { audio.play(); musicBtn.classList.add('playing'); showLyric("Music On ğŸµ"); } 
            else { audio.pause(); musicBtn.classList.remove('playing'); showLyric("Music Off ğŸ”‡"); }
        }

        // === 2. æ ¸å¿ƒä¸æ»‘äº¤äº’ï¼šç‚¹å‡»æ”¾å¤§/ç¼©å°é€»è¾‘ ===
        const treeArea = document.getElementById('click-area');
        const mainContainer = document.querySelector('.main-container');
        const uiPanel = document.getElementById('ui-panel');
        let isFocused = false;

        // A. ç‚¹å‡»æ ‘ï¼šæ”¾å¤§ + æŒ‚ç¯
        treeArea.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° mainContainer

            // å¦‚æœæ²¡æ”¾å¤§ï¼Œå…ˆæ”¾å¤§
            if (!isFocused) {
                isFocused = true;
                treeArea.classList.add('is-focused');
                mainContainer.classList.add('focus-mode');
            }

            // è®¡ç®—åæ ‡å¹¶æŒ‚ç¯
            const rect = treeArea.getBoundingClientRect();
            // åœ¨ scale çŠ¶æ€ä¸‹ï¼ŒgetBoundingClientRect ä¼šè¿”å›æ”¾å¤§åçš„å°ºå¯¸ï¼Œ
            // æˆ‘ä»¬çš„ç¯æ˜¯ append åˆ° treeArea å†…éƒ¨çš„ï¼Œæ‰€ä»¥ç”¨ç›¸å¯¹æ¯”ä¾‹è®¡ç®—æœ€ç¨³
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // ä¸ºäº†ä¿®æ­£ç¼©æ”¾å¯¼è‡´çš„åæ ‡åç§»ï¼Œç®€å•çš„åšæ³•æ˜¯è®¤ä¸ºç‚¹å‡»ä½ç½®å°±æ˜¯ç›¸å¯¹ä½ç½®
            // å› ä¸º pointer-events åœ¨å­å…ƒç´ ä¸Šä¹Ÿæ˜¯æœ‰æ•ˆçš„
            
            if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»æ”¾å¤§ï¼Œç¨å¾®å»¶è¿Ÿä¸€ç‚¹æŒ‚ç¯ï¼Œè§†è§‰æ›´æ¸…æ™°ï¼Œæˆ–è€…ç›´æ¥æŒ‚ç¯ä¹Ÿè¡Œ
                createLight(x, y, rect.width, rect.height); 
                createSparkles(e.clientX, e.clientY);
            }
        });

        // B. ç‚¹å‡»èƒŒæ™¯ï¼ˆmainContainerï¼‰ï¼šç¼©å°ï¼ˆé€€å‡ºä¸“æ³¨æ¨¡å¼ï¼‰
        mainContainer.addEventListener('click', function(e) {
            if (isFocused) {
                isFocused = false;
                treeArea.classList.remove('is-focused');
                mainContainer.classList.remove('focus-mode');
            }
        });
        
        // é˜»æ­¢ UI é¢æ¿çš„ç‚¹å‡»è§¦å‘èƒŒæ™¯ç‚¹å‡»äº‹ä»¶
        uiPanel.addEventListener('click', function(e){
            e.stopPropagation();
        });

        // === 3. ä¸šåŠ¡é€»è¾‘ ===
        const themes = {
            'multi': ['#ff4757', '#2ed573', '#ffa502', '#3742fa', '#e056fd', '#ffffff', '#00d2d3'],
            'gold': ['#ffd32a', '#fffa65', '#ff9f43', '#ffffff', '#fff200', '#eccc68'],
            'ice': ['#00d2d3', '#48dbfb', '#c7ecee', '#ffffff', '#54a0ff', '#81ecec']
        };
        let currentTheme = 'multi';

        function createLight(clickX, clickY, rectW, rectH) {
            const light = document.createElement('div'); light.className = 'light';
            const colors = themes[currentTheme]; 
            light.style.color = colors[Math.floor(Math.random() * colors.length)];
            const size = 12 + Math.random() * 6; 
            light.style.width = size + 'px'; light.style.height = size + 'px';
            
            // åæ ‡éœ€è¦é€‚é…ç¼©æ”¾ï¼šè¿™é‡Œç›´æ¥ç”¨ç‚¹å‡»ç›¸å¯¹åæ ‡å³å¯ï¼Œ
            // å› ä¸ºç¯æ˜¯ç»å¯¹å®šä½åœ¨ treeWrapper é‡Œçš„
            light.style.left = clickX + 'px'; 
            light.style.top = clickY + 'px';
            
            treeArea.appendChild(light);
        }

        function createSparkles(screenX, screenY) {
            for(let i=0; i<6; i++) {
                const spark = document.createElement('div'); spark.className = 'spark'; 
                document.body.appendChild(spark);
                spark.style.left = screenX + 'px'; spark.style.top = screenY + 'px';
                const angle = Math.random() * Math.PI * 2; const distance = 20 + Math.random() * 20;
                spark.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                spark.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                setTimeout(() => spark.remove(), 600);
            }
        }

        function switchTheme(themeName, btnElement) {
            currentTheme = themeName;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active')); 
            btnElement.classList.add('active');
            const existingLights = treeArea.querySelectorAll('.light'); const colors = themes[themeName];
            existingLights.forEach(light => {
                light.style.transition = 'color 0.4s ease, background 0.4s ease, box-shadow 0.4s ease';
                light.style.color = colors[Math.floor(Math.random() * colors.length)];
            });
            showLyric(`Theme: ${btnElement.innerText}`);
        }

        function autoDecorate(count = 30) {
            // è‡ªåŠ¨è£…é¥°æ—¶ï¼Œå¦‚æœä¸å¤„äºä¸“æ³¨æ¨¡å¼ï¼Œå¯ä»¥å¼ºåˆ¶è®©å®ƒä¸åŠ¨ï¼Œæˆ–è€…ä¸è¿›å…¥ä¸“æ³¨æ¨¡å¼
            const w = treeArea.offsetWidth; const h = treeArea.offsetHeight;
            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const factor = Math.random(); 
                    const x = (w/2) + (Math.random()-0.5) * (w * 0.8 * factor);
                    const y = h * 0.15 + (1-factor) * (h * 0.75); 
                    // æ¨¡æ‹Ÿ createLight çš„é€»è¾‘
                    const light = document.createElement('div'); light.className = 'light';
                    const colors = themes[currentTheme]; 
                    light.style.color = colors[Math.floor(Math.random() * colors.length)];
                    const size = 12 + Math.random() * 6; 
                    light.style.width = size + 'px'; light.style.height = size + 'px';
                    light.style.left = x + 'px'; light.style.top = y + 'px';
                    treeArea.appendChild(light);
                }, i * 30);
            }
        }
        function clearScene() { treeArea.querySelectorAll('.light').forEach(l => l.remove()); }

        const lyricEl = document.getElementById('lyric-text'); let lyricTimer;
        function showLyric(text) {
            lyricEl.innerText = text; lyricEl.classList.add('show'); clearTimeout(lyricTimer);
            lyricTimer = setTimeout(() => { lyricEl.classList.remove('show'); }, 2500);
        }

        // ä¸‹é›ª
        const canvas = document.getElementById('snow-canvas'); const ctx = canvas.getContext('2d');
        let width = window.innerWidth; let height = window.innerHeight; 
        canvas.width = width; canvas.height = height;
        const flakes = Array.from({length: 60}, () => ({ x: Math.random() * width, y: Math.random() * height, r: Math.random() * 2 + 0.5, v: Math.random() * 1 + 0.5, a: Math.random() * 0.4 + 0.1 }));
        function drawSnow() {
            ctx.clearRect(0, 0, width, height); ctx.fillStyle = '#fff';
            flakes.forEach(f => {
                f.y += f.v; if(f.y > height) { f.y = -5; f.x = Math.random() * width; }
                ctx.globalAlpha = f.a; ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(drawSnow);
        }
        drawSnow();
        window.onresize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
    </script>
</body>
</html>