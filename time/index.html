<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75, user-scalable=no, viewport-fit=cover">
    <title>XzCold OS v12.1.0 | Tech Art Core</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [核心保留] 字体与配色 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');

        :root { --bg: #050505; --sidebar-bg: #080808; --surface: #121212; --surface-hover: #1c1c1c; --border: #2a2a2a; --primary: #4f8aff; --accent: #ff4f81; --aurora: #4fffa3; --danger: #ff4f4f; --math: #b54fff; --logic: #ff9e4f; --phil: #00e5ff; --text-main: #fff; --text-dim: #888; --font-ui: 'Inter', 'Noto Sans SC', sans-serif; --font-mono: 'JetBrains Mono', monospace; --radius: 18px; --sidebar-width: 280px; --sidebar-collapsed-width: 80px; --bezier-smooth: cubic-bezier(0.2, 0.8, 0.2, 1); --ai-color: #00ff9d; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-ui); margin: 0; width: 100vw; height: 100vh; overflow: hidden; font-size: 15px; }

        /* [侧边栏] - 保持原样 */
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border); padding: 24px 20px; display: flex; flex-direction: column; z-index: 1000; overflow: hidden; white-space: nowrap; transition: width 0.5s var(--bezier-smooth), padding 0.5s var(--bezier-smooth); }
        body.sidebar-collapsed .sidebar { width: var(--sidebar-collapsed-width); padding: 24px 0; align-items: center; }
        .main-area { position: absolute; top: 0; right: 0; bottom: 0; left: var(--sidebar-width); background: var(--bg); z-index: 10; overflow: hidden; transition: left 0.5s var(--bezier-smooth); }
        body.sidebar-collapsed .main-area { left: var(--sidebar-collapsed-width); }
        .brand-text, .menu-text, .btn-text { opacity: 1; display: inline-block; vertical-align: middle; margin-left: 10px; transition: opacity 0.3s ease 0.2s, margin-left 0s 0.2s, width 0s 0.2s; width: auto; overflow: hidden; }
        body.sidebar-collapsed .brand-text, body.sidebar-collapsed .menu-text, body.sidebar-collapsed .btn-text { opacity: 0; width: 0; margin-left: 0; pointer-events: none; transition: opacity 0.1s ease 0s; }
        .toggle-btn { position: absolute; top: 24px; right: 16px; color: var(--text-dim); cursor: pointer; transition: right 0.5s var(--bezier-smooth), transform 0.5s; z-index: 20; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .toggle-btn:hover { background: var(--surface-hover); color: var(--primary); }
        body.sidebar-collapsed .toggle-btn { right: 50%; transform: translateX(50%) rotate(180deg); top: 24px; }
        .brand-container { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 40px; margin-top: 4px; position: relative; width: 100%; padding-left: 10px; transition: 0.5s; }
        body.sidebar-collapsed .brand-container { align-items: center; padding-left: 0; margin-top: 60px; }
        .brand { font-size: 20px; font-weight: 800; display: flex; align-items: center; color: var(--text-main); white-space: nowrap; height: 32px; width: 100%; transition: 0.5s; }
        body.sidebar-collapsed .brand { justify-content: center; }
        .brand-icon { color: var(--primary); font-size: 24px; transition: 0.5s; filter: drop-shadow(0 0 10px rgba(79,138,255,0.4)); flex-shrink: 0; }
        body.sidebar-collapsed .brand-icon { font-size: 28px; transform: scale(1.1); }
        .ai-status-group { display: flex; align-items: center; margin-top: 6px; gap: 8px; transition: all 0.5s; cursor: pointer; }
        body.sidebar-collapsed .ai-status-group { margin-top: 8px; flex-direction: column-reverse; gap: 4px; }
        .model-name-full { font-family: var(--font-mono); font-size: 10px; color: #666; font-weight: 700; transition: 0.3s; opacity: 0.8; display: block; }
        .model-name-short { font-family: var(--font-mono); font-size: 9px; color: var(--primary); font-weight: 800; transition: 0.3s; display: none; text-align: center; transform: scale(0.9); }
        body.sidebar-collapsed .model-name-full { display: none; }
        body.sidebar-collapsed .model-name-short { display: block; }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 800; background: #1a1a1a; color: #444; border: 1px solid #333; transition: all 0.5s; display: inline-block; white-space: nowrap; }
        body.sidebar-collapsed .status-pill { padding: 1px 4px; font-size: 9px; }
        .status-pill.online { background: rgba(79, 255, 163, 0.1); color: var(--aurora); border-color: var(--aurora); box-shadow: 0 0 10px rgba(79, 255, 163, 0.3); animation: pulse-green 3s infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 10px rgba(79, 255, 163, 0.3); } 50% { box-shadow: 0 0 20px rgba(79, 255, 163, 0.6); } }
        .status-pill.error { background: rgba(255, 79, 79, 0.1); color: var(--danger); border-color: var(--danger); }
        .menu-container { display: flex; flex-direction: column; gap: 8px; flex: 1; width: 100%; }
        .menu-item { display: flex; align-items: center; gap: 0; padding: 14px 18px; border-radius: 14px; color: var(--text-dim); cursor: pointer; transition: 0.2s cubic-bezier(0.2, 0, 0, 1); font-weight: 600; position: relative; white-space: nowrap; overflow: hidden; }
        body.sidebar-collapsed .menu-item { justify-content: center; padding: 16px 0; width: 50px; margin: 0 auto; }
        .menu-item:hover { background: var(--surface-hover); color: var(--text-main); }
        .menu-item.active { background: rgba(79, 138, 255, 0.12); color: var(--primary); font-weight: 700; }
        .menu-icon { width: 24px; text-align: center; font-size: 18px; transition: 0.2s; display: flex; justify-content: center; flex-shrink: 0; }
        body.sidebar-collapsed .menu-icon { font-size: 22px; width: 100%; }
        .sync-controls { margin-top: auto; display: flex; gap: 8px; margin-bottom: 10px; width: 100%; padding: 0 10px;}
        body.sidebar-collapsed .sync-controls { flex-direction: column; align-items: center; padding: 0; }
        .sync-btn { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; color: var(--text-dim); background: rgba(255,255,255,0.02); transition: 0.2s; font-size:12px; display:flex; align-items:center; justify-content: center; gap:0;}
        .sync-btn:hover { background: var(--surface); color: var(--text-main); border-color: #555; }
        body.sidebar-collapsed .sync-btn { padding: 14px 0; width: 40px; margin: 0 auto; }
        .api-btn { width:calc(100% - 20px); margin:0 10px 8px 10px; padding: 14px; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; font-size: 13px; color: var(--aurora); font-weight: 600; background: rgba(79, 255, 163, 0.05); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 0; white-space: nowrap; overflow: hidden; }
        body.sidebar-collapsed .api-btn { padding: 14px 0; width: 40px; margin: 0 auto 8px auto; }
        .api-btn:hover { border-color: var(--aurora); background: rgba(79, 255, 163, 0.1); }

        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; visibility: hidden; opacity: 0; overflow-y: auto; overflow-x: hidden; transition: opacity 0.6s var(--bezier-smooth), transform 0.6s var(--bezier-smooth), visibility 0s linear 0.6s; transform: scale(0.98); }
        .dashboard-page { padding: 40px; box-sizing: border-box; }
        .page.active { visibility: visible; opacity: 1; transform: translateY(0) scale(1); z-index: 10; pointer-events: auto; transition: opacity 0.6s var(--bezier-smooth), transform 0.6s var(--bezier-smooth), visibility 0s linear 0s; }
        
        #page-home { grid-template-columns: 50% 50%; align-items: center; overflow: hidden; padding: 0; position: relative; }
        .home-content-container { z-index: 20; padding-left: 80px; position: relative; display: flex; flex-direction: column; justify-content: center; height: 100%; pointer-events: none; width: 100%; max-width: 1400px; margin: 0 auto; }
        .home-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .neon-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 80% 20%, rgba(79, 138, 255, 0.12) 0%, transparent 50%), radial-gradient(circle at 20% 80%, rgba(79, 255, 163, 0.08) 0%, transparent 50%); mix-blend-mode: color-dodge; z-index: 2; pointer-events: none; animation: neonPulse 10s infinite alternate; }
        @keyframes neonPulse { 0% { opacity: 0.4; } 100% { opacity: 0.7; } }
        .home-title-group { pointer-events: auto; display: flex; flex-direction: column; gap: 0; }
        .home-big-text { font-family: 'Inter', sans-serif; font-size: 160px; font-weight: 900; color: #fff; line-height: 0.9; letter-spacing: -4px; margin: 0; text-transform: uppercase; }
        .home-big-text:first-child { color: #fff; }
        .home-big-text.gradient { background: linear-gradient(135deg, #4f8aff 0%, #4fffa3 50%, #ff4f81 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 30px rgba(79,138,255,0.4)); }
        .home-quote { margin-top: 60px; font-family: var(--font-mono); font-size: 18px; color: #999; line-height: 1.6; max-width: 600px; border-left: 3px solid var(--primary); padding-left: 20px; pointer-events: auto; transition: opacity 0.5s; }
        .home-quote.typing { opacity: 0.5; }
        .home-section-title { margin-top: 40px; margin-bottom: 0px; font-size: 10px; color: var(--text-dim); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; pointer-events: auto; font-family: var(--font-mono); display: flex; align-items: center; gap: 10px; }
        .home-section-title::before { content: ''; display: block; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
        .home-section-title.custom::before { background: #666; }
        .home-section-title.hidden { display: none; }
        .home-tasks-container { margin-top: 15px; margin-bottom: 40px; width: 100%; max-width: 1100px; pointer-events: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; padding: 0; max-height: 40vh; overflow-y: auto; padding-right: 10px; }
        .home-waiting-card { grid-column: 1 / -1; border: 1px dashed var(--border); border-radius: 12px; padding: 25px; text-align: center; color: #444; font-family: var(--font-mono); background: rgba(255,255,255,0.01); display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .home-waiting-card:hover { border-color: #555; background: rgba(255,255,255,0.02); }
        .home-waiting-card i { font-size: 24px; color: #333; }
        
        /* Task Cards */
        .home-task-card { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(16px); border-radius: 12px; padding: 16px 20px; min-height: 110px; font-family: var(--font-mono); display: flex; flex-direction: column; justify-content: flex-start; gap: 8px; transition: transform 0.3s, box-shadow 0.4s ease, border-color 0.4s ease, opacity 0.4s ease; animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(15px); cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .home-task-card.custom-task { border-left: 3px solid #555; }
        .home-task-card:hover { transform: translateY(-4px); background: rgba(30, 30, 30, 0.8); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .home-task-card.done { opacity: 0.3; filter: grayscale(100%) brightness(0.7); box-shadow: none !important; border-color: rgba(255,255,255,0.02) !important; background: rgba(10,10,10,0.3) !important; transform: scale(0.98); }
        .home-task-card.done .task-label, .home-task-card.done .task-dot, .home-task-card.done .task-content { color: #444 !important; text-shadow: none !important; text-decoration: line-through; }
        
        /* Category Colors */
        .home-task-card.type-tech:hover { border-color: var(--primary); box-shadow: 0 0 25px rgba(79, 138, 255, 0.2); }
        .home-task-card.type-eng:hover { border-color: var(--accent); box-shadow: 0 0 25px rgba(255, 79, 129, 0.2); }
        .home-task-card.type-design:hover { border-color: var(--aurora); box-shadow: 0 0 25px rgba(79, 255, 163, 0.2); }
        .home-task-card.type-math:hover { border-color: var(--math); box-shadow: 0 0 25px rgba(181, 79, 255, 0.2); }
        .home-task-card.type-logic:hover { border-color: var(--logic); box-shadow: 0 0 25px rgba(255, 158, 79, 0.2); }
        .home-task-card.type-phil:hover { border-color: var(--phil); box-shadow: 0 0 25px rgba(0, 229, 255, 0.2); }
        
        .home-task-card.type-tech .task-label, .home-task-card.type-tech .task-dot { color: var(--primary); }
        .home-task-card.type-eng .task-label, .home-task-card.type-eng .task-dot { color: var(--accent); }
        .home-task-card.type-design .task-label, .home-task-card.type-design .task-dot { color: var(--aurora); }
        .home-task-card.type-math .task-label, .home-task-card.type-math .task-dot { color: var(--math); }
        .home-task-card.type-logic .task-label, .home-task-card.type-logic .task-dot { color: var(--logic); }
        .home-task-card.type-phil .task-label, .home-task-card.type-phil .task-dot { color: var(--phil); }

        .task-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0; width: 100%; }
        .task-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 6px; opacity: 0.9; transition: color 0.4s; }
        .task-dot { width: 5px; height: 5px; border-radius: 50%; box-shadow: 0 0 5px currentColor; transition: all 0.4s; }
        .task-content { font-size: 13px; font-weight: 500; color: #ddd; line-height: 1.4; font-family: var(--font-ui); text-align: left; transition: color 0.4s; }
        .home-task-card:nth-child(1) { animation-delay: 0.05s; }
        .home-task-card:nth-child(2) { animation-delay: 0.1s; }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        .ai-feedback-box { margin-top: 10px; padding: 12px; background: linear-gradient(145deg, rgba(0, 255, 157, 0.05) 0%, rgba(0, 255, 157, 0.02) 100%); border: 1px solid rgba(0, 255, 157, 0.2); border-radius: 8px; font-size: 12px; color: #ccc; line-height: 1.5; font-family: var(--font-mono); position: relative; animation: slideUp 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .ai-feedback-box::before { content: 'AI MENTOR FEEDBACK:'; display: block; font-weight: 800; color: var(--ai-color); font-size: 9px; margin-bottom: 6px; letter-spacing: 1px; }

        .focus-task-item { padding: 16px; background: rgba(255,255,255,0.03); border-radius: 12px; font-size: 15px; display: flex; flex-direction: column; cursor: pointer; margin-bottom: 8px; border: 1px solid transparent; transition: 0.2s; }
        .focus-task-row { display: flex; align-items: center; width: 100%; } 
        .focus-task-item:hover { background: rgba(255,255,255,0.06); transform: translateX(2px); border-color: rgba(255,255,255,0.1); }
        .focus-task-item.done .text-content { opacity: 0.4; text-decoration: line-through; }
        .focus-task-item.done.locked { cursor: not-allowed; opacity: 0.6; }
        .focus-task-item.done.locked:hover { transform: none; border-color: transparent; }
        
        .btn-del { margin-left: auto; color: #444; padding: 8px; border-radius: 6px; transition: 0.2s; opacity: 0; }
        .focus-task-item:hover .btn-del { opacity: 1; }
        .btn-del:hover { color: var(--accent); background: rgba(255, 79, 129, 0.1); }
        .focus-task-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 14px; flex-shrink: 0; }
        .focus-task-item.ai-task { border-color: rgba(0, 255, 157, 0.15); background: rgba(0, 255, 157, 0.02); }
        .focus-task-item.ai-task .focus-task-dot { background: var(--ai-color); box-shadow: 0 0 8px var(--ai-color); }
        
        .ai-badge { font-size: 9px; background: var(--ai-color); color: #000; padding: 2px 5px; border-radius: 4px; font-weight: 800; font-family: var(--font-mono); margin-left: 0; } 
        .lock-icon { font-size: 10px; color: #666; margin-left: 8px; margin-right: 6px; display: flex; align-items: center; gap: 6px; }

        .task-refresh-btn { font-size: 12px; color: var(--text-dim); margin-left: 10px; cursor: pointer; transition: 0.3s; padding: 5px; border-radius: 5px; }
        .task-refresh-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .task-refresh-btn.spinning { animation: fa-spin 1s infinite linear; pointer-events: none; color: var(--primary); }

        .scroll-hint { position: absolute; bottom: 50px; left: 80px; font-size: 12px; color: rgba(255,255,255,0.3); animation: pulseFade 3s infinite; display: flex; align-items: center; gap: 10px; font-family: var(--font-mono); letter-spacing: 2px; pointer-events: auto; cursor: pointer; z-index: 20; }
        @keyframes pulseFade { 0%, 100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 0.8; transform: translateY(5px); } }

        #page-focus { grid-template-columns: 360px 1fr; grid-template-rows: auto 1fr; gap: 24px; }
        #page-schedule { grid-template-columns: 60% 40%; grid-template-rows: 100%; gap: 24px; height: 100vh; padding-bottom: 0; overflow: hidden; }
        #page-schedule.dashboard-page { padding: 40px; padding-bottom: 40px; }
        
        #page-growth { grid-template-columns: 1fr; gap: 24px; width: 100%; max-width: none; align-content: start; } 
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; display: flex; flex-direction: column; position: relative; transition: border-color 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card:hover { border-color: #444; }
        .timer-card { grid-column: 1 / 2; grid-row: 1 / 2; align-items: center; background: #0f0f0f; border: 1px solid #222; }
        .timer-ring { width: 220px; height: 220px; border-radius: 50%; background: conic-gradient(var(--primary) var(--p), #1a1a1a 0deg); display: flex; align-items: center; justify-content: center; margin: 10px 0 20px 0; box-shadow: 0 0 40px rgba(79, 138, 255, 0.08); }
        @property --p { syntax: '<angle>'; initial-value: 0deg; inherits: false; }
        .timer-inner { width: 206px; height: 206px; background: #0f0f0f; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-val { font-family: var(--font-mono); font-size: 56px; font-weight: 700; cursor: pointer; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .timer-controls-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-mini { background: transparent; border: 1px solid #333; color: #888; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-family: var(--font-mono); font-size: 12px; }
        .btn-focus { background: var(--primary); color: #000; border: none; padding: 16px 0; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; width: 100%; margin-top: auto; transition: 0.2s; }
        .btn-focus:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 138, 255, 0.3); }
        .stats-card { grid-column: 2 / 3; grid-row: 1 / 2; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1px; background: var(--border); border: 1px solid var(--border); padding: 1px; overflow: hidden; }
        .stat-item { text-align: center; background: var(--surface); padding: 20px; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .stat-val { font-family: var(--font-mono); font-size: 32px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 8px; font-weight: 800; letter-spacing: 1px; }
        .tasks-focus-card { grid-column: 1 / -1; grid-row: 2 / 3; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 700; font-size: 16px; }
        #focus_task_list { flex: 1; overflow-y: auto; padding-right: 5px; min-height: 200px; }
        
        .calendar-card { grid-column: 1 / 2; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .schedule-list-card { grid-column: 2 / 3; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .card-header-right { font-family: var(--font-mono); color: var(--primary); font-size: 14px; }
        .day-focus-stat { background: rgba(79,138,255,0.1); border:1px solid rgba(79,138,255,0.2); padding:16px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); gap: 4px; margin-top: 15px; flex: 1; align-content: stretch; height: 100%; min-height: 0; }
        .cal-day { border-radius: 6px; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: 700; flex-direction: column; width: 100%; height: 100%; min-height: 0; transition: 0.2s; aspect-ratio: unset; }
        .cal-day:hover { background: rgba(255,255,255,0.08); }
        .cal-day.active { border: 2px solid var(--primary); color: var(--primary); background: rgba(79, 138, 255, 0.1); }
        .cal-day.today { color: var(--accent); }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text-dim); opacity: 0; margin-top: 6px; }
        .cal-day.has-data .cal-dot { opacity: 1; background: var(--primary); }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .todo-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .todo-check { width: 20px; height: 20px; border: 2px solid #555; border-radius: 6px; margin-right: 12px; cursor: pointer; flex-shrink: 0; }
        .focus-task-item.done.locked .focus-task-dot, .focus-task-item.done.locked .todo-check { background: #333; border-color: #333; cursor: not-allowed; }
        
        .eng-stat-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .eng-card { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .eng-val { font-size: 36px; font-weight: 700; font-family: var(--font-mono); position: relative; z-index: 2; margin-top: 5px; }
        .eng-title { font-size: 12px; color: #666; font-weight: 700; position: relative; z-index: 2; text-transform: uppercase; letter-spacing: 1px; }
        
        .rank-badge { display: inline-block; background: rgba(79, 138, 255, 0.15); color: var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; margin-bottom: 8px; border: 1px solid rgba(79, 138, 255, 0.3); }
        .rank-progress-container { width: 100%; height: 4px; background: #222; border-radius: 2px; margin-top: 15px; position: relative; z-index: 2; overflow: hidden; }
        .rank-progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; box-shadow: 0 0 10px var(--primary); }
        .rank-meta { font-size: 10px; color: #555; margin-top: 5px; display: flex; justify-content: space-between; font-family: var(--font-mono); position: relative; z-index: 2; }

        .eng-bg-icon { position: absolute; right: 10px; bottom: -10px; font-size: 80px; color: var(--text-main); opacity: 0.05; transform: rotate(-15deg); pointer-events: none; z-index: 1; }
        .eng-task { display: flex; align-items: center; padding: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .eng-task:hover { border-color: var(--primary); }
        .eng-check { width: 24px; height: 24px; border: 2px solid #555; margin-right: 20px; border-radius: 6px; }
        .eng-task.done .eng-check { background: var(--success); border-color: var(--success); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-box { background: #1a1a1a; border: 1px solid #333; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        .modal-input { width: 100%; background: #0a0a0a; border: 1px solid #333; color: #fff; padding: 14px; margin: 10px 0; border-radius: 10px; font-family: var(--font-mono); text-align: center; font-size: 12px; }
        .modal-btn { background: var(--primary); color: #000; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.2s; }
        .modal-btn:hover { opacity: 0.9; transform: scale(1.05); }
        .modal-btn.cancel { background: transparent; border: 1px solid #444; color: #fff; }
        .mobile-sync-container, .mobile-only { display: none; }
        
        .preview-area { width: 100%; height: 150px; border: 2px dashed #333; border-radius: 10px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px; position: relative; overflow: hidden; cursor: pointer; }
        .preview-area:hover { border-color: var(--primary); color: var(--primary); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .preview-area.has-img .preview-img { display: block; }
        .preview-area.has-img span { display: none; }

        #toast { visibility: hidden; min-width: 300px; background-color: #1a1a1a; border: 2px solid var(--primary); color: #fff; text-align: center; border-radius: 50px; padding: 20px 40px; position: fixed; z-index: 9999; left: 50%; bottom: 40px; transform: translateX(-50%); font-size: 16px; font-weight: 700; font-family: var(--font-mono); box-shadow: 0 10px 40px rgba(79, 138, 255, 0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 80px; }

        @media (max-width: 768px) {
            html { font-size: 14px; height: auto; }
            body { display: block; height: auto; min-height: 100vh; overflow-y: auto; overflow-x: hidden; position: static; }
            .sidebar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; border-right: none; border-bottom: 1px solid var(--border); padding: 0 20px; flex-direction: row; align-items: center; justify-content: space-between; overflow: visible; z-index: 5000; background: rgba(8,8,8,0.95); backdrop-filter: blur(10px); transition: none; }
            .brand-container { margin: 0; flex-direction: row; align-items: center; gap: 12px; width: auto; padding-left: 0; }
            .brand { margin: 0; font-size: 18px; justify-content: flex-start; }
            .status-pill { margin: 0; display: inline-block !important; opacity: 1 !important; }
            .toggle-btn, .menu-container, .desktop-only { display: none !important; }
            .main-area { margin-top: 60px; height: auto; overflow: visible; padding: 0; left: 0; }
            .page { position: relative; display: flex !important; opacity: 1; visibility: visible; transform: none; overflow: visible; height: auto; flex-direction: column; gap: 20px; padding-bottom: 40px; }
            .scroll-hint { display: none; }
            #page-home { height: calc(100vh - 60px); justify-content: center; text-align: center; margin-bottom: 0; padding-bottom: 0; }
            .home-big-text { font-size: 60px; letter-spacing: -3px; }
            .home-content-container { padding: 0 30px; }
            .home-quote { border-left: none; padding-left: 0; margin: 20px auto; }
            .dashboard-page { padding: 20px; overflow: visible; height: auto; }
            .card { margin-bottom: 0; flex-shrink: 0; }
            #page-schedule { height: auto !important; overflow: visible !important; display: block !important; padding-bottom: 100px; grid-template-columns: 1fr; grid-template-rows: auto auto; }
            .calendar-card { height: auto !important; min-height: auto; }
            .cal-grid { gap: 1px; min-height: auto; margin-top: 10px; grid-template-rows: repeat(6, 50px); }
            .cal-day { font-size: 12px; min-height: 0; aspect-ratio: auto; padding: 0; border-radius: 4px; }
            .schedule-list-card { height: auto !important; }
            .todo-list { max-height: none; overflow-y: visible; } 
            .stats-card { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: transparent; border: none; padding: 0; }
            .stat-item { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 16px; }
            .mobile-only { display: block; }
            .mobile-sync-area { display: block; padding: 20px; margin-top: 40px; border-top: 1px dashed #333; }
            .sync-btn-mobile { flex: 1; background: #222; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; font-size: 13px; display: flex; justify-content: center; align-items: center; gap: 6px; }
            .btn-del { opacity: 1; color: #333; }
            .home-section-title { margin-top: 30px; justify-content: center; }
            .home-tasks-container { margin-top: 15px; }
        }

        #boot-layer { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.8s cubic-bezier(0.8,0,0,1); }
        .boot-logo { font-size: 40px; color: #fff; margin-bottom: 20px; animation: pulse 2s infinite; }
        .boot-bar { width: 120px; height: 3px; background: #222; border-radius: 3px; overflow: hidden; }
        .boot-prog { width: 0%; height: 100%; background: var(--primary); animation: load 1.5s ease-out forwards; }
        @keyframes load { to { width: 100%; } }
        body.loaded #boot-layer { transform: translateY(-100%); pointer-events: none; }
    </style>
</head>
<body>

<div id="boot-layer"><div class="boot-logo"><i class="fa-solid fa-cube fa-bounce"></i></div><div class="boot-bar"><div class="boot-prog"></div></div></div>
<div id="toast">Generating...</div>

<div class="sidebar" id="sidebar">
    <div class="toggle-btn" onclick="window.toggleSidebar()"><i class="fa-solid fa-chevron-left"></i></div>
    <div class="brand-container">
        <div class="brand"><i class="fa-solid fa-cube brand-icon"></i><span class="brand-text">XZCOLD OS</span></div>
        <div class="ai-status-group" onclick="window.openApiModal()">
            <span class="model-name-full" id="model-display">未连接</span>
            <div id="connStatus" class="status-pill">AI</div>
            <span class="model-name-short" id="model-short-display">N/A</span>
        </div>
    </div>
    
    <div class="menu-container">
        <div id="nav-home" class="menu-item active" onclick="window.switchPage('home')"><div class="menu-icon"><i class="fa-solid fa-house"></i></div><span class="menu-text">首页</span></div>
        <div id="nav-focus" class="menu-item" onclick="window.switchPage('focus')"><div class="menu-icon"><i class="fa-regular fa-clock"></i></div><span class="menu-text">专注</span></div>
        <div id="nav-schedule" class="menu-item" onclick="window.switchPage('schedule')"><div class="menu-icon"><i class="fa-regular fa-calendar"></i></div><span class="menu-text">日程</span></div>
        <div id="nav-growth" class="menu-item" onclick="window.switchPage('growth')"><div class="menu-icon"><i class="fa-solid fa-chart-line"></i></div><span class="menu-text">成长</span></div>
    </div>
    
    <div class="sync-controls desktop-only">
        <div class="sync-btn" onclick="window.exportData()"><i class="fa-solid fa-cloud-arrow-up"></i> <span class="btn-text">备份</span></div>
        <div class="sync-btn" onclick="window.importData()"><i class="fa-solid fa-cloud-arrow-down"></i> <span class="btn-text">恢复</span></div>
    </div>
    
    <div class="api-btn desktop-only" onclick="window.openApiModal()"><i class="fa-solid fa-key"></i> <span class="btn-text">API 密钥</span></div>
</div>

<div class="main-area" id="mainArea">
    <div id="page-home" class="page active">
        <div class="neon-gradient"></div>
        <div class="home-bg-layer"><canvas id="gemini-canvas"></canvas></div>
        <div class="home-content-container">
            <div class="home-title-group">
                <h1 class="home-big-text">HELLO</h1>
                <h1 class="home-big-text gradient">XZCOLD</h1>
            </div>
            <div class="home-quote" id="daily-quote">系统初始化中...</div>
            
            <div class="home-section-title">每日指令 // 智能生成</div>
            <div class="home-tasks-container" id="home-tasks-ai"></div>

            <div class="home-section-title custom" id="title-user">自定义协议 // 手动添加</div>
            <div class="home-tasks-container" id="home-tasks-user"></div>

            <div class="scroll-hint interactive-text desktop-only" onclick="window.switchPage('focus')"><i class="fa-solid fa-angle-down"></i> 下滑浏览</div>
        </div>
    </div>

    <div id="page-focus" class="page dashboard-page">
        <div class="card timer-card">
            <div style="font-size:12px; color:#666; margin-bottom:5px; font-weight:700; letter-spacing:1px;">专注计时器</div>
            <div class="timer-ring" id="f_ring" style="--p: 360deg"><div class="timer-inner"><div class="time-val" id="f_display" onclick="window.editTimer()">25:00</div></div></div>
            <div class="timer-controls-row"><button class="btn-mini" onclick="window.adjTime(-5)">-5</button><button class="btn-mini" onclick="window.adjTime(5)">+5</button></div>
            <button class="btn-focus" onclick="window.toggleTimer()" id="f_btn">开始专注</button>
        </div>
        <div class="card stats-card">
            <div class="stat-item"><div class="stat-label">今日分钟</div><div class="stat-val" id="f_today">0</div></div>
            <div class="stat-item"><div class="stat-label">连胜天数</div><div class="stat-val" id="f_streak">0</div></div>
            <div class="stat-item"><div class="stat-label">最高记录</div><div class="stat-val" id="f_max_streak">0</div></div>
            <div class="stat-item"><div class="stat-label">每日目标</div><div class="stat-val editable" id="f_goal" onclick="window.editGoal()">5h</div></div>
        </div>
        <div class="card tasks-focus-card">
            <div class="card-header"><div>今日任务</div><span style="font-size:12px; color:var(--primary); cursor:pointer;" onclick="window.switchPage('schedule')">管理 ></span></div>
            <div id="focus_task_list"></div>
        </div>
    </div>

    <div id="page-schedule" class="page dashboard-page">
        <div class="card calendar-card">
            <div class="card-header"><span id="cal_title" style="font-size:18px;">2025</span><div><i class="fa-solid fa-chevron-left" style="cursor:pointer; margin-right:20px;" onclick="window.changeMonth(-1)"></i><i class="fa-solid fa-chevron-right" style="cursor:pointer;" onclick="window.changeMonth(1)"></i></div></div>
            <div class="cal-grid" id="cal_body"></div>
        </div>
        <div class="schedule-list-card card">
            <div class="card-header">
                <span id="sched_title">任务列表</span>
                <span id="sched_current_date" class="card-header-right"></span>
            </div>
            <div class="day-focus-stat">
                <span style="font-size:12px; color:#888; font-weight:700;">每日专注</span>
                <span style="font-size:20px; font-weight:700; color:#fff; font-family:var(--font-mono);" id="sched_focus_val">0m</span>
            </div>
            <div class="input-group"><input type="text" id="sched_input" placeholder="添加任务..." onkeypress="if(event.key==='Enter') window.addTask()" style="flex:1; background:#000; border:1px solid #333; color:#fff; padding:12px; border-radius:10px;"><button class="btn-add" onclick="window.addTask()" style="background:#222; border:1px solid #333; color:#fff; width:40px; border-radius:10px; cursor:pointer;">+</button></div>
            <div class="todo-list" id="sched_list"></div>
        </div>
    </div>

    <div id="page-growth" class="page dashboard-page">
        <div class="eng-stat-row">
            <div class="eng-card">
                <i class="fa-solid fa-fire eng-bg-icon"></i>
                <div class="eng-title">任务连胜</div>
                <div class="eng-val" id="eng_streak">0</div>
                <div class="eng-sub">最高记录: <span id="eng_max_streak">0</span></div>
            </div>
            <div class="eng-card">
                <i class="fa-solid fa-layer-group eng-bg-icon"></i>
                <div class="eng-title">当前职级 (RANK)</div>
                <div class="eng-val" id="growth_rank_name" style="color:var(--primary); font-size:24px;">初学者 (NOVICE)</div>
                <div class="rank-badge" id="growth_diff_label">难度: 入门 (Lv.1)</div>
                <div class="rank-progress-container"><div class="rank-progress-bar" id="growth_prog_bar"></div></div>
                <div class="rank-meta"><span>XP: <span id="eng_xp">0</span></span><span id="growth_next_xp">PERF: 1000</span></div>
            </div>
        </div>
        <div class="eng-task-list">
            <div style="margin-bottom:15px; font-size:12px; color:#666; font-weight:700; text-transform:uppercase; letter-spacing:1px;">每日固定训练</div>
            <div class="eng-task" onclick="window.toggleEng(0)"><div class="eng-check"></div><div><div style="font-weight:700; margin-bottom:4px;">视觉分析 (5m)</div><div style="font-size:12px; color:#888;">截图场景 -> 标注光影/构图</div></div></div>
            <div class="eng-task" onclick="window.toggleEng(1)"><div class="eng-check"></div><div><div style="font-weight:700; margin-bottom:4px;">视觉绑定</div><div style="font-size:12px; color:#888;">用英语命名 UE5 资产</div></div></div>
            <div class="eng-task" onclick="window.toggleEng(2)"><div class="eng-check"></div><div><div style="font-weight:700; margin-bottom:4px;">逻辑阅读</div><div style="font-size:12px; color:#888;">不查词典，靠逻辑猜词</div></div></div>
        </div>
        <button class="btn-focus" style="margin-top:20px; background:#222; border:1px solid #333; color:#fff;" onclick="window.resetEng()">完成固定训练 (+3 XP)</button>
        
        <div class="mobile-only mobile-sync-area">
             <div style="display:flex; gap:10px;">
                 <div class="sync-btn-mobile" onclick="window.exportData()"><i class="fa-solid fa-cloud-arrow-up"></i> 备份</div>
                 <div class="sync-btn-mobile" onclick="window.importData()"><i class="fa-solid fa-cloud-arrow-down"></i> 恢复</div>
                 <div class="sync-btn-mobile" onclick="window.openApiModal()"><i class="fa-solid fa-key"></i> 密钥</div>
             </div>
        </div>
    </div>
</div>

<div id="apiModal" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--aurora)">CORTEX ACCESS</h3>
        <p style="font-size:13px; color:#aaa; margin-bottom:20px;">请输入 Gemini API 密钥</p>
        <input type="password" id="apiKeyInput" class="modal-input" placeholder="AIzaSy...">
        <p style="font-size:13px; color:#aaa; margin-top:10px;">API 代理地址 (必填)</p>
        <input type="text" id="apiBaseInput" class="modal-input" placeholder="https://generativelanguage.googleapis.com">
        <div style="font-size:11px; color:var(--primary); margin-top:15px; font-weight:700; font-family:var(--font-mono);" id="time-to-refresh">NEXT REFRESH: CALCULATING...</div>
        <div style="display:flex; justify-content:center; margin-top:20px;"><button class="modal-btn cancel" onclick="window.closeApiModal()">取消</button><button class="modal-btn" onclick="window.saveApiKey()">激活</button></div>
    </div>
</div>

<div id="verifyModal" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--primary)">TASK VERIFICATION</h3>
        <p style="font-size:13px; color:#aaa; margin-bottom:15px;" id="verify-task-text">任务内容...</p>
        
        <textarea id="verify-text-input" class="modal-input" placeholder="输入文字描述或代码..." style="height:80px; text-align:left;"></textarea>
        
        <div class="preview-area" onclick="document.getElementById('evidence-upload').click()">
            <input type="file" id="evidence-upload" accept="image/*" style="display:none" onchange="window.handleFileSelect(this)">
            <img id="verify-img-preview" class="preview-img">
            <span><i class="fa-solid fa-image"></i> 点击上传截图 (UE5/Blender)</span>
        </div>

        <div style="display:flex; justify-content:center; margin-top:20px;">
            <button class="modal-btn cancel" onclick="window.closeVerifyModal()">取消</button>
            <button class="modal-btn" onclick="window.submitVerify()">提交验证</button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('load', () => { setTimeout(() => document.body.classList.add('loaded'), 1800); });

    const DB = { 
        get: (k) => { try { return JSON.parse(localStorage.getItem('xz_' + k)); } catch(e) { return null; } },
        set: (k, v) => localStorage.setItem('xz_' + k, JSON.stringify(v)), 
        getOr: (k, def) => { try { return JSON.parse(localStorage.getItem('xz_' + k)) || def; } catch(e) { return def; } } 
    };
    
    // [核心重写] 每日任务算法 - 时区强制偏移
    function getLogicalDate() { 
        const now = new Date();
        // 1. 获取 UTC 时间戳
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        // 2. 转换为北京时间 (UTC+8)
        const beijingTime = new Date(utc + (3600000 * 8)); 
        // 3. 定义新的一天开始于北京时间 07:00:00
        // 如果当前是 06:59:59 BJ，我们减去7小时，仍在前一天。
        // 如果当前是 07:00:00 BJ，我们减去7小时，进入新的一天 00:00:00。
        beijingTime.setHours(beijingTime.getHours() - 7); 
        return beijingTime.toISOString().split('T')[0];
    }
    
    // [核心可视化] 倒计时显示
    function updateRefreshCountdown() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const bj = new Date(utc + (3600000 * 8));
        
        // 目标: 下一个 07:00:00
        let target = new Date(bj);
        target.setHours(7, 0, 0, 0);
        
        // 如果当前已经过了7点，目标则是明天的7点
        if(bj.getHours() >= 7) { 
            target.setDate(target.getDate() + 1); 
        }
        
        const diff = target - bj;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        
        const el = document.getElementById('time-to-refresh');
        if(el) el.innerText = `NEXT REFRESH (BJ 7:00): ${h}H ${m}M ${s}S`;
    }
    setInterval(updateRefreshCountdown, 1000);

    let state = { page: 'home', date: new Date(), selDate: getLogicalDate(), total: 25 * 60, curr: 25 * 60, run: false, timer: null, goal: parseFloat(DB.getOr('goal', 5)), verifyId: null, verifyImgBase64: null };
    let currentLogicalDate = getLogicalDate();

    function updateGlobalState() { renderTasks(); renderHomeTasks(); renderEng(); renderStats(); renderCal(); updateRefreshCountdown(); }
    window.addEventListener('storage', (e) => { if(e.key && e.key.startsWith('xz_')) { updateGlobalState(); } });

    function getTaskCount() { return DB.getOr('global_task_count', 0); }
    function getPerfScore() { return DB.getOr('perf_score', 1000); }
    
    function getRankInfo() {
        const xp = getTaskCount();
        const score = getPerfScore();
        let baseName = "初学者", baseDesc = "Recall", baseDiff = "Lv.1";
        
        if (xp < 100) { baseName = "初学者 (NOVICE)"; baseDesc = "Cognition"; baseDiff = "Lv.1"; }
        else if (xp < 200) { baseName = "学徒 (APPRENTICE)"; baseDesc = "Application"; baseDiff = "Lv.2"; }
        else if (xp < 300) { baseName = "熟手 (ADEPT)"; baseDesc = "Analysis"; baseDiff = "Lv.3"; }
        else if (xp < 400) { baseName = "专家 (EXPERT)"; baseDesc = "Creation"; baseDiff = "Lv.4"; }
        else { baseName = "大师 (MASTER)"; baseDesc = "Philosophy"; baseDiff = "Lv.5"; }

        if(score > 1200) baseDiff += " (HARD+)";
        else if(score < 800) baseDiff += " (EASY-)";

        return { name: baseName, next: Math.floor(xp/100 + 1)*100, desc: baseDesc, diff: baseDiff, score: score };
    }

    function addTaskCount(amount) {
        let current = getTaskCount(); let newCount = current + amount; if(newCount < 0) newCount = 0; 
        DB.set('global_task_count', newCount);
        updateGlobalState();
    }
    
    function updatePerfScore(delta) {
        let s = getPerfScore() + delta;
        if(s < 0) s = 0; if(s > 2000) s = 2000;
        DB.set('perf_score', s);
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 4000);
    }

    window.refreshAiTask = function(taskId, typeClass) {
        const taskEl = document.getElementById(`refresh-icon-${taskId}`);
        if(taskEl) taskEl.classList.add('spinning');
        let pType = "tech";
        if(typeClass.includes('eng')) pType = "eng";
        else if(typeClass.includes('design')) pType = "design"; 
        else if(typeClass.includes('math')) pType = "math";
        else if(typeClass.includes('logic')) pType = "logic";
        else if(typeClass.includes('phil')) pType = "phil";
        askGemini('single_refresh', { id: taskId, pType: pType });
    };

    // [核心修改] 2025-12-22 智能模型调度与严格分类 (Social Logic, Design, Real English)
    async function askGemini(type, data = null) {
        const k = localStorage.getItem('xz_gemini_key');
        const baseUrl = localStorage.getItem('xz_api_base') || "https://generativelanguage.googleapis.com";
        const statusEl = document.getElementById('connStatus');
        const modelEl = document.getElementById('model-display');
        const modelShortEl = document.getElementById('model-short-display');
        
        if (!k) {
            statusEl.classList.remove('online'); statusEl.classList.remove('error');
            modelEl.innerText = "离线"; modelShortEl.innerText = "OFF";
            if (type === 'daily') { document.getElementById('daily-quote').innerText = "SYSTEM OFFLINE"; renderHomeTasks(); }
            return;
        }

        const rank = getRankInfo();
        const googleInstruction = `IMPORTANT: Before generating any answer, you MUST mentally simulate a Google Search to verify facts. Ensure accuracy.`;
        
        // [核心修正] 植入 "Tech Art" 专用语境
        let rankInstruction = `Current Rank: ${rank.name}. Performance Score: ${rank.score}. Context: XzCold (18yo Student, 3D Artist, UE5/Blender, TikTok Creator).`;
        const noPinyinInstruction = `STRICT RULE: OUTPUT CHINESE CHARACTERS ONLY. NO ROMANIZATION/PINYIN.`;
        
        let prompt = "";
        let requestParts = [];

        if (type === 'daily') {
            prompt = `SYSTEM: You are a specialized 3D Tech Art Coach.
            ${googleInstruction}
            ${rankInstruction}
            ${noPinyinInstruction}
            RULES:
            1. STRICT JSON OUTPUT ONLY. No markdown.
            2. TASKS MUST BE SHORT (<20 chars).
            3. CATEGORIES MUST MATCH EXACTLY (Tech, Eng, Design, Math, Logic, Phil):
               - "tech" (Tech): UE5/Blender specific hotkey or tool trick.
               - "eng" (English): 3D/CG Term (e.g. Albedo, Bake) + English Definition (Simple) + Chinese Context. NOT JUST A TRANSLATION.
               - "design" (Design): Composition, Lighting, Color Theory, or Visual Storytelling task.
               - "math" (Math): Concept Awareness (e.g. Dot Product usage) - NO CALCULATIONS. Just "Understand [Concept] for [Usage]".
               - "logic" (Social Logic): TikTok Content Strategy, Psychology, Industry Networking.
               - "phil" (Philosophy): Environmental Storytelling, Art Philosophy.
            4. ABSOLUTELY NO GENERIC MATH or LOGIC.
            Output JSON: { "quote": "Deep Chinese Quote", "tasks": [ { "type": "tech", "text": "..." }, { "type": "eng", "text": "..." }, { "type": "design", "text": "..." }, { "type": "math", "text": "..." }, { "type": "logic", "text": "..." }, { "type": "phil", "text": "..." } ] }`;
            requestParts.push({ text: prompt });
        }
        else if (type === 'task_verify') {
            prompt = `Role: Strict AI Teacher.
            ${googleInstruction}
            ${noPinyinInstruction}
            User Answer: "${data.a}".
            Task was: "${data.q}".
            Action: 
            1. Analyze text AND image (if provided).
            2. Grade it: S (Perfect), A (Good), B (Pass), F (Fail).
            3. Provide short constructive feedback in CHINESE (No Pinyin, <30 words).
            4. Output JSON: { "grade": "A", "feedback": "...", "score_delta": 10 }.`;
            
            requestParts.push({ text: prompt });
            if (data.img) {
                requestParts.push({ inline_data: { mime_type: "image/jpeg", data: data.img.split(',')[1] } });
            }
        }
        else if (type === 'single_refresh') {
            // [重大修复] 刷新单条任务时，必须携带完整的 Context 和 Rules，否则 AI 会忘记 "不准拼音" 和 "Tech Art" 背景
            prompt = `SYSTEM: You are a specialized 3D Tech Art Coach.
            ${googleInstruction}
            ${rankInstruction}
            ${noPinyinInstruction}
            TASK: Generate ONE short (<15 chars) 3D Tech Art task for category [${data.pType}]. 
            STRICT DEFINITION:
            - TECH: UE5/Blender tool trick (e.g. Nanite, Lumen, GeoNodes).
            - ENG: CG Term + Eng Def + Chinese Meaning.
            - DESIGN: Composition/Lighting.
            - MATH: Concept Awareness (No Calc).
            - LOGIC: Social Logic (TikTok Strategy/Networking).
            - PHIL: Art Philosophy.
            Output plain text CHINESE (No Pinyin).`;
            requestParts.push({ text: prompt });
        }
        else if (type === 'focus_done') { requestParts.push({ text: "User finished focus session. Give short cyber-style praise in Chinese (No Pinyin)." }); }
        else if (type === 'eng_done') { requestParts.push({ text: "User finished visual training. Give short encouraging phrase in Chinese (No Pinyin)." }); }
        else if (type === 'ping') { requestParts.push({ text: "Ping." }); }

        if (type === 'daily') {
            document.getElementById('daily-quote').innerText = "系统连接中..."; 
            document.getElementById('daily-quote').classList.add('typing');
        }

        const models = ['gemini-3-flash', 'gemma-3-27b-it', 'gemini-2.5-flash', 'gemini-2.0-flash-exp']; 
        let success = false;
        let lastError = "";

        for (let model of models) {
            try {
                const cleanBase = baseUrl.replace(/\/$/, "");
                const res = await fetch(`${cleanBase}/v1beta/models/${model}:generateContent?key=${k}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: requestParts }] })
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                
                if (!json.error && json.candidates) {
                    let text = json.candidates[0].content.parts[0].text.trim().replace(/```json/g, '').replace(/```/g, '');
                    if (text.startsWith('{')) { const start = text.indexOf('{'); const end = text.lastIndexOf('}'); text = text.substring(start, end + 1); }

                    if (type === 'daily') {
                        try {
                            const data = JSON.parse(text);
                            document.getElementById('daily-quote').innerText = data.quote;
                            document.getElementById('daily-quote').classList.remove('typing');
                            syncTasksToDB(data.tasks); 
                            localStorage.setItem('xz_v95_growth_engine', JSON.stringify({ date: getLogicalDate(), data: data }));
                            updateGlobalState(); 
                        } catch(e) { document.getElementById('daily-quote').innerText = "指令解析失败"; }
                    } else if (type === 'task_verify') {
                         try {
                             const resData = JSON.parse(text);
                             let l = DB.getOr('tasks', []);
                             let task = l.find(t => t.id === data.id);
                             if(task) { 
                                 task.feedback = `[${resData.grade}] ${resData.feedback}`; 
                                 updatePerfScore(resData.score_delta || 0);
                                 DB.set('tasks', l); 
                                 updateGlobalState(); 
                             }
                             window.closeVerifyModal();
                             alert(`【评级: ${resData.grade}】\n${resData.feedback}\n表现分: ${resData.score_delta > 0 ? '+' : ''}${resData.score_delta}`);
                         } catch(e) { alert("验证解析失败: " + text); }
                    } else if (type === 'single_refresh') {
                        let l = DB.getOr('tasks', []);
                        let task = l.find(t => t.id === data.id);
                        if(task) {
                            task.text = `[${data.pType.toUpperCase()}] ${text}`;
                            DB.set('tasks', l);
                            updateGlobalState();
                            showToast("任务已刷新");
                        }
                    } else if (type !== 'ping') { showToast(text); } 
                    else if (type === 'ping') { showToast("神经网络已连接"); checkDailyQuote(); }
                    
                    success = true;
                    statusEl.classList.remove('error'); statusEl.classList.add('online'); 
                    
                    let displayModel = model.replace('gemini-', '').replace('gemma-', 'G-').replace('-preview', '').replace('-exp', '').replace('-it', '');
                    if(model.includes('gemini-3')) displayModel = "Gemini 3 Flash";
                    if(model.includes('gemma-3')) displayModel = "Gemma 3 27B";
                    
                    modelEl.innerText = displayModel;
                    modelShortEl.innerText = model.includes('3') ? "G-3.0" : "G-2.5";
                    break; 
                }
            } catch (e) { lastError = e.message; }
        }

        if (!success) {
            statusEl.classList.remove('online'); statusEl.classList.add('error'); 
            modelEl.innerText = "错误"; modelShortEl.innerText = "ERR";
            if (type === 'daily') {
                document.getElementById('daily-quote').innerText = "连接中断";
                document.getElementById('daily-quote').classList.remove('typing');
                renderHomeTasks(); 
            } else if (type === 'ping') { showToast("连接失败: " + lastError); }
            if(type === 'single_refresh') {
                const taskEl = document.getElementById(`refresh-icon-${data.id}`);
                if(taskEl) taskEl.classList.remove('spinning');
            }
        }
    }

    function syncTasksToDB(aiTasks) {
        let currentTasks = DB.getOr('tasks', []);
        const today = getLogicalDate();
        const hasAiTasks = currentTasks.some(t => t.date === today && t.isAI);
        if (!hasAiTasks && aiTasks) {
            aiTasks.forEach(t => {
                currentTasks.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    text: `[${t.type.toUpperCase()}] ${t.text}`,
                    type: t.type, date: today, done: false, created: Date.now(), isAI: true, feedback: null
                });
            });
            DB.set('tasks', currentTasks);
        }
    }

    function renderHomeTasks() {
        const aiBox = document.getElementById('home-tasks-ai');
        const userBox = document.getElementById('home-tasks-user');
        const userTitle = document.getElementById('title-user');
        aiBox.innerHTML = ''; userBox.innerHTML = '';
        const allTasks = DB.getOr('tasks', []).filter(t => t.date === getLogicalDate());
        const aiTasks = allTasks.filter(t => t.isAI);
        const userTasks = allTasks.filter(t => !t.isAI);
        const hasKey = localStorage.getItem('xz_gemini_key');

        if (aiTasks.length > 0) {
            aiTasks.forEach(t => aiBox.appendChild(createTaskCard(t)));
        } else {
            const waitingHtml = `
                <div class="home-waiting-card" onclick="window.openApiModal()">
                    <i class="fa-solid fa-satellite-dish"></i>
                    <div>${hasKey ? 'Waiting for Command...' : 'WAITING FOR UPLINK...'}</div>
                    <div style="font-size:10px; opacity:0.6;">${hasKey ? '正在接收每日指令' : '请连接 API 获取每日任务'}</div>
                </div>`;
            aiBox.innerHTML = waitingHtml;
        }
        if (userTasks.length > 0) { userTitle.classList.remove('hidden'); userBox.style.display = 'grid'; userTasks.forEach(t => { const card = createTaskCard(t); card.classList.add('custom-task'); userBox.appendChild(card); }); } 
        else { userTitle.classList.add('hidden'); userBox.style.display = 'none'; }
    }

    function createTaskCard(t) {
        let typeClass = 'type-tech';
        // [修正] Robust Classification Mapping
        if(t.isAI) { 
            const txt = t.text.toLowerCase();
            const type = t.type ? t.type.toLowerCase() : '';
            if(type === 'eng' || txt.includes('[eng]')) typeClass = 'type-eng'; 
            else if(type === 'design' || txt.includes('[design]')) typeClass = 'type-design'; 
            else if(type === 'math' || txt.includes('[math]')) typeClass = 'type-math'; 
            else if(type === 'logic' || txt.includes('[logic]')) typeClass = 'type-logic'; 
            else if(type === 'phil' || txt.includes('[phil]')) typeClass = 'type-phil'; 
        }
        const el = document.createElement('div');
        // [核心修复] 2025-12-22: 点击事件移动到父容器，解决点击穿透/无效问题
        el.className = `home-task-card ${typeClass} ${t.done ? 'done' : ''}`;
        el.onclick = function() { togTask(t.id); };
        
        let labelText = t.isAI ? '指令' : '自定义';
        if(t.isAI) { 
            if(typeClass === 'type-tech') labelText = '<i class="fa-solid fa-microchip"></i> 3D 技术 (TECH)'; 
            else if(typeClass === 'type-eng') labelText = '<i class="fa-solid fa-language"></i> 行业英语 (ENG)'; 
            // [核心修正] 确保 Design 类名匹配
            else if(typeClass === 'type-design') labelText = '<i class="fa-solid fa-palette"></i> 场景设计 (DESIGN)'; 
            else if(typeClass === 'type-math') labelText = '<i class="fa-solid fa-square-root-variable"></i> 图形数学 (MATH)'; 
            // [核心修改] 2025-12-22 Logic标签更改为社交逻辑
            else if(typeClass === 'type-logic') labelText = '<i class="fa-solid fa-puzzle-piece"></i> 社交逻辑 (SOCIAL LOGIC)'; 
            else if(typeClass === 'type-phil') labelText = '<i class="fa-solid fa-lightbulb"></i> 艺术哲学 (PHIL)'; 
        }
        
        const refreshBtn = (t.isAI && !t.done) ? `<i class="fa-solid fa-arrows-rotate task-refresh-btn" id="refresh-icon-${t.id}" onclick="event.stopPropagation(); window.refreshAiTask('${t.id}', '${typeClass}')"></i>` : '';
        el.innerHTML = `<div class="task-header"><div class="task-label">${labelText}</div><div style="display:flex; align-items:center;">${refreshBtn}<div class="task-dot" style="margin-left:8px;"></div></div></div><div class="task-content">${t.text.replace(/\[.*?\]\s*/, '')}</div>`;
        return el;
    }

    // [核心重写] 缓存验证与旧数据清理
    function checkDailyQuote() {
        const cache = DB.getOr('xz_v95_growth_engine', null); 
        const today = getLogicalDate();
        
        // 如果缓存日期不等于今天的逻辑日期，强制清空旧数据
        if (cache && cache.date !== today) {
            console.log("Date change detected. Invalidate cache.");
            localStorage.removeItem('xz_v95_growth_engine');
        }

        const isValid = cache && cache.date === today && cache.data && Array.isArray(cache.data.tasks);
        
        if (isValid) { 
            document.getElementById('daily-quote').innerText = cache.data.quote; 
            syncTasksToDB(cache.data.tasks); 
            updateGlobalState(); 
        } 
        else { 
            const hasKey = localStorage.getItem('xz_gemini_key'); 
            if(hasKey) askGemini('daily'); 
            else renderHomeTasks(); 
        }
    }

    window.openVerifyModal = function(taskId) {
        state.verifyId = taskId;
        state.verifyImgBase64 = null;
        const task = DB.getOr('tasks', []).find(t => t.id === taskId);
        if(!task) return;
        document.getElementById('verify-task-text').innerText = task.text;
        document.getElementById('verify-text-input').value = "";
        document.getElementById('verify-img-preview').src = "";
        document.querySelector('.preview-area').classList.remove('has-img');
        document.getElementById('verifyModal').style.display = 'flex';
    };
    window.closeVerifyModal = function() { document.getElementById('verifyModal').style.display = 'none'; };
    window.handleFileSelect = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                state.verifyImgBase64 = e.target.result;
                document.getElementById('verify-img-preview').src = state.verifyImgBase64;
                document.querySelector('.preview-area').classList.add('has-img');
            };
            reader.readAsDataURL(input.files[0]);
        }
    };
    window.submitVerify = function() {
        const text = document.getElementById('verify-text-input').value;
        const img = state.verifyImgBase64;
        if(!text && !img) { alert("请提供文字说明或截图证据！"); return; }
        document.getElementById('verifyModal').style.display = 'none';
        showToast("AI 正在验证证据...");
        askGemini('task_verify', { id: state.verifyId, q: document.getElementById('verify-task-text').innerText, a: text || "[IMAGE SUBMITTED]", img: img });
    };

    window.toggleSidebar = function() { document.body.classList.toggle('sidebar-collapsed'); };
    const PAGES = ['home', 'focus', 'schedule', 'growth']; let isAnimating = false;
    window.switchPage = function(pid) { if(window.innerWidth<=768){document.getElementById('page-'+pid).scrollIntoView({behavior:'smooth'});}else{if(state.page===pid)return;document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));document.getElementById('nav-'+pid)?.classList.add('active');isAnimating=true;const o=PAGES.indexOf(state.page),n=PAGES.indexOf(pid),d=n>o?'next':'prev',op=document.getElementById('page-'+state.page),np=document.getElementById('page-'+pid);document.querySelectorAll('.page').forEach(p=>p.classList.remove('active','prev','next'));void np.offsetWidth;if(d==='next'){op.classList.add('prev');np.classList.add('active');}else{op.classList.add('next');np.classList.add('active');}setTimeout(()=>isAnimating=false,600);state.page=pid;} };
    let lastScroll=0;window.addEventListener('wheel',(e)=>{ if(window.innerWidth<=768)return;if(isAnimating)return;let t=e.target,is=false;while(t&&t!==document.body){if(t.classList&&(t.classList.contains('todo-list')||t.classList.contains('dashboard-page')||t.classList.contains('page')||t.classList.contains('home-tasks-container')||t.tagName==='TEXTAREA')){if((e.deltaY>0&&t.scrollTop<t.scrollHeight-t.clientHeight-5)||(e.deltaY<0&&t.scrollTop>5))is=true;}t=t.parentElement;}if(is)return;const now=Date.now();if(now-lastScroll<500)return;const c=PAGES.indexOf(state.page);if(e.deltaY>0){if(c<PAGES.length-1){switchPage(PAGES[c+1]);lastScroll=now;}}else if(e.deltaY<0){if(c>0){switchPage(PAGES[c-1]);lastScroll=now;}}},{passive:true});
    const canvas=document.getElementById('gemini-canvas'),ctx=canvas.getContext('2d');let width,height,mouseX=-1000,mouseY=-1000,orb={x:0,y:0,rad:220};function resizeCanvas(){width=canvas.parentElement.offsetWidth;height=canvas.parentElement.offsetHeight;canvas.width=width;canvas.height=height;orb.x=width*(window.innerWidth>768?0.75:0.5);orb.y=height*0.5;}window.addEventListener('resize',resizeCanvas);resizeCanvas();document.addEventListener('mousemove',(e)=>{if(state.page==='home'){const r=canvas.getBoundingClientRect();mouseX=e.clientX-r.left;mouseY=e.clientY-r.top;document.querySelectorAll('.interactive-text').forEach(el=>{const b=el.getBoundingClientRect(),cx=b.left+b.width/2,cy=b.top+b.height/2,d=Math.hypot(e.clientX-cx,e.clientY-cy);if(d<300){const p=(300-d)/300;el.style.transform=`translate(${(e.clientX-cx)*0.1*p}px,${(e.clientY-cy)*0.1*p}px)`;}else{el.style.transform='none';}});}});function drawNebula(){ if(state.page!=='home'&&window.innerWidth>768){requestAnimationFrame(drawNebula);return;}if(!ctx)return;ctx.clearRect(0,0,width,height);const t=Date.now()*0.002,dx=mouseX-orb.x,dy=mouseY-orb.y,d=Math.hypot(dx,dy),int=Math.max(0,(500-d)/500),cx=orb.x+(dx*int*0.08),cy=orb.y+(dy*int*0.08);ctx.globalCompositeOperation='lighter';[`hsl(${210+int*50},100%,60%)`,`hsl(${150+int*100},100%,70%)`,`hsl(${280-int*50},100%,60%)`].forEach((c,i)=>{const ox=Math.sin(t*(1+i*0.2))*50,oy=Math.cos(t*(1+i*0.3))*50,r=orb.rad*(0.8+Math.sin(t+i)*0.2)+(int*60),g=ctx.createRadialGradient(cx+ox,cy+oy,r*0.1,cx+ox,cy+oy,r*1.5);g.addColorStop(0,c);g.addColorStop(0.1,c);g.addColorStop(0.6,'transparent');ctx.fillStyle=g;ctx.globalAlpha=0.5+(int*0.3);ctx.beginPath();ctx.arc(cx+ox,cy+oy,r*1.5,0,Math.PI*2);ctx.fill();});ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1;requestAnimationFrame(drawNebula);}drawNebula();
    
    window.addTask=function(){const i=document.getElementById('sched_input');let v=i.value.trim();if(!v)return;const n=Date.now().toString()+Math.random().toString(36).substr(2,5),t={text:v,date:state.selDate,done:false,created:Date.now(),isAI:false};let l=DB.getOr('tasks',[]);l.push({id:n,...t});DB.set('tasks',l);i.value='';updateGlobalState();};
    window.togTask=function(id){
        let l=DB.getOr('tasks',[]),i=l.find(x=>x.id==id);
        if(i){
            if(i.isAI && i.done) { alert("【协议锁定】AI 生成的 3D 训练任务一旦提交，不可撤销。\n请继续前进。"); return; }
            if(i.isAI && !i.done) { window.openVerifyModal(id); return; }
            i.done=!i.done;
            if(i.done){ addTaskCount(1); } else { addTaskCount(-1); }
            DB.set('tasks',l);
            updateGlobalState();
        }
    };

    window.deleteTask=function(e,id){e.stopPropagation();if(!confirm("确认删除？"))return;let l=DB.getOr('tasks',[]);l=l.filter(x=>x.id!=id);DB.set('tasks',l);updateGlobalState();};
    
    window.renderTasks=function(){ 
        const t=state.selDate,all=DB.getOr('tasks',[]),fl=document.getElementById('focus_task_list'),sl=document.getElementById('sched_list');
        fl.innerHTML=''; sl.innerHTML='';
        const renderItem = (x) => {
             const feedbackHtml = x.feedback ? `<div class="ai-feedback-box">${x.feedback}</div>` : '';
             const lockClass = (x.isAI && x.done) ? 'locked' : '';
             const lockIcon = (x.isAI && x.done) ? '<i class="fa-solid fa-lock lock-icon"></i>' : '';
             return `<div class="focus-task-item ${x.done?'done':''} ${x.isAI?'ai-task':''} ${lockClass}" onclick="togTask('${x.id}')"><div class="focus-task-row"><div class="focus-task-dot"></div><span class="text-content" style="flex:1">${x.text}</span>${lockIcon}${x.isAI?'<span class="ai-badge">AI</span>':''}<i class="fa-solid fa-trash btn-del" onclick="deleteTask(event,'${x.id}')"></i></div>${feedbackHtml}</div>`;
        };
        all.filter(x=>x.date===getLogicalDate()).forEach(x=>{ fl.innerHTML += renderItem(x); });
        all.filter(x=>x.date===t).forEach(x=>{ sl.innerHTML += renderItem(x); });
    };
    
    window.openApiModal=function(){document.getElementById('apiModal').style.display='flex';document.getElementById('apiKeyInput').value=localStorage.getItem('xz_gemini_key')||'';document.getElementById('apiBaseInput').value=localStorage.getItem('xz_api_base')||'';};window.closeApiModal=function(){document.getElementById('apiModal').style.display='none';};window.saveApiKey=function(){const k=document.getElementById('apiKeyInput').value.trim(),b=document.getElementById('apiBaseInput').value.trim()||"https://generativelanguage.googleapis.com";if(k){localStorage.setItem('xz_gemini_key',k);localStorage.setItem('xz_api_base',b);closeApiModal();askGemini('ping');}};window.exportData=function(){const d={tasks:DB.getOr('tasks',[]),history:DB.getOr('history',{}),streak:DB.getOr('streak',0),maxStreak:DB.getOr('max_streak',0),lastStreakDate:DB.getOr('last_streak_date',''),eng:DB.getOr('eng_tasks',[false,false,false]),engStats:{streak:DB.getOr('eng_streak',0),maxStreak:DB.getOr('eng_max_streak',0),maxLvl:DB.getOr('eng_max_lvl',1),lastDate:DB.getOr('eng_last_date','')},goal:DB.getOr('goal',5),globalCount:DB.getOr('global_task_count',0), perf:DB.getOr('perf_score', 1000)};navigator.clipboard.writeText(JSON.stringify(d)).then(()=>alert("已复制!"));};window.importData=function(){const s=prompt("请粘贴备份代码:");if(s){try{const d=JSON.parse(s);if(d.tasks)DB.set('tasks',d.tasks);if(d.history)DB.set('history',d.history);if(d.streak)DB.set('streak',d.streak);if(d.maxStreak)DB.set('max_streak',d.maxStreak);if(d.lastStreakDate)DB.set('last_streak_date',d.lastStreakDate);if(d.eng)DB.set('eng_tasks',d.eng);if(d.engStats){DB.set('eng_streak',d.engStats.streak);DB.set('eng_max_streak',d.engStats.maxStreak);DB.set('eng_max_lvl',d.engStats.maxLvl);DB.set('eng_last_date',d.engStats.lastDate);}if(d.goal)DB.set('goal',d.goal);if(d.globalCount)DB.set('global_task_count',d.globalCount);if(d.perf)DB.set('perf_score',d.perf);alert("恢复成功!");location.reload();}catch(e){alert("无效代码");}}};function checkEnglishReset(){const t=getLogicalDate(),l=DB.getOr('eng_last_date','');if(l&&l!==t){const y=new Date();y.setDate(y.getDate()-1);if(l!==y.toISOString().split('T')[0])DB.set('eng_streak',0);DB.set('eng_tasks',[false,false,false]);}renderEng();}function checkFocusStreakReset(){const t=getLogicalDate(),l=DB.getOr('last_streak_date','');if(l&&l!==t){const y=new Date();y.setDate(y.getDate()-1);if(l!==y.toISOString().split('T')[0])DB.set('streak',0);}renderStats();}window.editTimer=function(){if(!state.run){const v=prompt("设置分钟:",state.total/60);if(v&&!isNaN(v)){state.total=parseInt(v)*60;state.curr=state.total;renderTimer();}}};window.adjTime=function(m){if(!state.run){state.total+=m*60;if(state.total<60)state.total=60;state.curr=state.total;renderTimer();}};window.toggleTimer=function(){if(state.run){clearInterval(state.timer);state.run=false;localStorage.removeItem('xz_timer_end');localStorage.removeItem('xz_timer_total');settleTime();btnUpdate();}else{state.run=true;state.endTime=Date.now()+(state.curr*1000);localStorage.setItem('xz_timer_end');localStorage.setItem('xz_timer_total');state.timer=setInterval(tick,1000);btnUpdate();}};function btnUpdate(){const b=document.getElementById('f_btn');b.innerText=state.run?"暂停":"开始专注";b.style.background=state.run?"var(--primary)":"var(--primary)";b.style.color="#000";}function tick(){if(!state.run)return;const r=state.endTime-Date.now();if(r<=0){state.curr=0;finishFocus();}else{state.curr=Math.round(r/1000);renderTimer();}}function checkRunningTimer(){const e=localStorage.getItem('xz_timer_end'),tot=localStorage.getItem('xz_timer_total');if(e&&tot){const end=parseInt(e);state.total=parseInt(tot);if(end>Date.now()){state.endTime=end;state.run=true;state.timer=setInterval(tick,1000);btnUpdate();}else{state.curr=0;settleTime();localStorage.removeItem('xz_timer_end');localStorage.removeItem('xz_timer_total');state.curr=state.total;renderTimer();alert("专注完成 (离线)");}}}function renderTimer(){document.getElementById('f_display').innerText=`${Math.floor(state.curr/60).toString().padStart(2,'0')}:${(state.curr%60).toString().padStart(2,'0')}`;document.getElementById('f_ring').style.setProperty('--p',`${(state.curr/state.total)*360}deg`);}function settleTime(){const el=state.total-state.curr,m=Math.floor(el/60);if(m>0){const t=getLogicalDate();let h=DB.getOr('history',{});h[t]=(h[t]||0)+m;DB.set('history',h);if(h[t]>=state.goal*60){const l=DB.getOr('last_streak_date','');if(l!==t){const ns=DB.getOr('streak',0)+1;DB.set('streak',ns);const max=DB.getOr('max_streak',0);if(ns>max)DB.set('max_streak',ns);DB.set('last_streak_date',t);}}state.total=state.curr;updateGlobalState();}}function finishFocus(){clearInterval(state.timer);state.run=false;localStorage.removeItem('xz_timer_end');localStorage.removeItem('xz_timer_total');askGemini('focus_done');settleTime();state.curr=state.total;renderTimer();btnUpdate();}function renderStats(){const t=getLogicalDate();document.getElementById('f_today').innerText=DB.getOr('history',{})[t]||0;document.getElementById('f_streak').innerText=DB.getOr('streak',0);document.getElementById('f_max_streak').innerText=DB.getOr('max_streak',0);}window.editGoal=function(){const v=prompt("目标 (小时):",state.goal);if(v){state.goal=parseFloat(v);DB.set('goal',state.goal);document.getElementById('f_goal').innerText=v+'h';updateGlobalState();}};window.changeMonth=function(d){state.date.setMonth(state.date.getMonth()+d);renderCal();};function renderCal(){const y=state.date.getFullYear(),m=state.date.getMonth();document.getElementById('cal_title').innerText=`${y} / ${m+1}`;const f=new Date(y,m,1).getDay(),d=new Date(y,m+1,0).getDate(),c=document.getElementById('cal_body'),hist=DB.getOr('history',{});c.innerHTML='';document.getElementById('sched_current_date').innerText=state.selDate;document.getElementById('sched_focus_val').innerText=(hist[state.selDate]||0)+"m";for(let i=0;i<f;i++)c.appendChild(document.createElement('div'));for(let i=1;i<=d;i++){const el=document.createElement('div');el.className='cal-day';const s=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;if(s===getLogicalDate())el.classList.add('today');if(s===state.selDate)el.classList.add('active');if((hist[s]||0)>0)el.classList.add('has-data');el.onclick=()=>{state.selDate=s;renderCal();renderTasks();};el.innerHTML=`<span>${i}</span><div class="cal-dot"></div>`;c.appendChild(el);}}
    
    function renderEng(){
        const s=DB.getOr('eng_streak',0),ms=DB.getOr('eng_max_streak',0),xp=getTaskCount();
        const rank = getRankInfo();
        document.getElementById('eng_streak').innerText=s;
        document.getElementById('eng_max_streak').innerText=ms;
        document.getElementById('eng_xp').innerText=xp;
        document.getElementById('growth_rank_name').innerText = rank.name;
        document.getElementById('growth_diff_label').innerText = "难度: " + rank.diff;
        document.getElementById('growth_next_xp').innerText = "PERF: " + rank.score;
        
        let prevLimit = 0;
        if(rank.name.includes('APPRENTICE')) prevLimit = 100;
        if(rank.name.includes('ADEPT')) prevLimit = 200;
        if(rank.name.includes('EXPERT')) prevLimit = 300;
        if(rank.name.includes('MASTER')) prevLimit = 400;
        
        let prog = 0;
        if(rank.next < 9000) { prog = ((xp - prevLimit) / (rank.next - prevLimit)) * 100; } else { prog = 100; }
        
        document.getElementById('growth_prog_bar').style.width = Math.min(Math.max(prog, 0), 100) + '%';
        const t=DB.getOr('eng_tasks',[false,false,false]);
        document.querySelectorAll('.eng-task').forEach((el,i)=>{if(t[i])el.classList.add('done');else el.classList.remove('done');});
    }

    window.toggleEng=function(i){let t=DB.getOr('eng_tasks',[false,false,false]);t[i]=!t[i];DB.set('eng_tasks',t);updateGlobalState();};window.resetEng=function(){let t=DB.getOr('eng_tasks',[false,false,false]);if(t.every(Boolean)){const ns=DB.getOr('eng_streak',0)+1;DB.set('eng_streak',ns);if(ns>DB.getOr('eng_max_streak',0))DB.set('eng_max_streak',ns);DB.set('eng_last_date',getLogicalDate());askGemini('eng_done');addTaskCount(3);DB.set('eng_tasks',[false,false,false]);updateGlobalState();}else{alert("请先完成所有任务！");}};

    setInterval(() => { const n=getLogicalDate(); if(n!==currentLogicalDate){ currentLogicalDate=n; state.selDate=n; checkEnglishReset(); checkFocusStreakReset(); checkDailyQuote(); updateGlobalState(); } }, 60000);

    checkEnglishReset(); checkFocusStreakReset(); checkRunningTimer(); document.getElementById('f_goal').innerText = state.goal + 'h'; 
    checkDailyQuote(); updateGlobalState(); updateRefreshCountdown();
</script>
</body>
</html>